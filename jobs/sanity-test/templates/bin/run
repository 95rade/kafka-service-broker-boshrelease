#!/bin/bash

exec 2>&1

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

export PATH=/var/vcap/packages/eden-cli/bin:$PATH
export PATH=/var/vcap/packages/bosh-cli/bin:$PATH

export HOME=/var/vcap/sys/run/sanity-test/home
mkdir -p $HOME
export EDEN_CONFIG=/var/vcap/sys/run/sanity-test/home/.eden/config

############################################################################

<%
  broker = link("kafka-service-broker")
  protocol = broker.p("protocol", broker.p("ssl_enabled", false) ? "https" : "http")
  username = broker.p("username")
  password = broker.p("password")
  host = broker.p("external_host", broker.instances.first.address)
  url = "#{protocol}://#{host}"
  uri = "#{protocol}://#{username}:#{password}@#{host}"
  broker.if_p("port") do |broker_port|
    uri += ":#{broker_port}"
    url += ":#{broker_port}"
  end
%>

echo Service catalog
export SB_BROKER_URL=<%= url %>
export SB_BROKER_USERNAME="<%= username %>"
export SB_BROKER_PASSWORD="<%= password %>"

echo SB_BROKER_URL=<%= url %>
echo SB_BROKER_USERNAME="<%= username %>"
echo SB_BROKER_PASSWORD="<%= password %>"
echo eden catalog
eden catalog

eden provision -s starkandwayne-kafka

export SB_INSTANCE=$(bosh int $EDEN_CONFIG --path /service_instances/0/id)
eden bind

credentials=$(bosh int $EDEN_CONFIG --path /service_instances/0/bindings/0/credentials)
echo "credentials: $credentials"

errors=

topicName=$(bosh int <(echo $credentials) --path /topicName)
kafkaHostnames=$(bosh int <(echo $credentials) --path /hostname)
uri=$(bosh int <(echo $credentials) --path /uri)

if [[ "$topicName" != "$SB_INSTANCE" ]]; then
  echo "ERROR: expected topicName '$topicName' to equal service instance ID '$SB_INSTANCE'"
  errors=1
fi
if [[ "$uri" != "kafka://$kafkaHostnames/$topicName" ]]; then
  echo "ERROR: expected uri 'kafka://$kafkaHostnames/$topicName' to equal '$uri'"
  errors=1
fi

eden unbind -b $(bosh int $EDEN_CONFIG --path /service_instances/0/bindings/0/id)

eden deprovision

if [[ "$errors" == "1" ]]; then
  exit 1
fi
